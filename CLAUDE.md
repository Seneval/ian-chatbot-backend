# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

### Development
- **Run development server**: `npm run dev` - Starts server with nodemon on port 3000 (auto-reloads on changes)
- **Start production server**: `npm start` - Runs server without auto-reload
- **Install dependencies**: `npm install` - Installs all packages including mongoose for MongoDB

### Deployment
- **Deploy to Vercel**: `vercel` - Deploys to production (auto-deploys on git push to main)
- **Preview deployment**: Push to any branch creates preview URL

### Testing
- **Manual API testing**: Use `/api/test/*` endpoints (no auth required)
- **Test OpenAI assistant**: `GET /api/test/assistant/:assistantId`
- **Full chat flow test**: `POST /api/test/full-test`

## Multi-Agent Architecture

This backend works in conjunction with another Claude Code agent managing the frontend repository (`ian2` or `ianwebsite`). 

### Agent Responsibilities
- **This agent (Backend)**: 
  - API endpoints and business logic
  - Database models and migrations
  - Authentication and authorization
  - Widget serving (`/widget.js`)
  - OpenAI integration

- **Frontend agent (ian2/ianwebsite)**:
  - Admin dashboard UI
  - Client management interface
  - Analytics visualization
  - Makes API calls to this backend

### Cross-Repository Communication
When the frontend needs changes:
1. Frontend expects specific API endpoints (e.g., `/client` not `/clients`)
2. Frontend sends `x-client-token` header for client auth
3. Frontend sends `Authorization: Bearer` header for admin auth
4. Widget embeds are generated by backend, consumed by frontend

## Architecture Overview

### Core Flow
```
Frontend Dashboard → API Endpoints → MongoDB/In-Memory Storage
         ↓                  ↓
   Widget Embed ← Widget.js ← OpenAI Assistant
```

### Database Strategy
- **MongoDB**: Primary storage when `MONGODB_URI` is set
- **In-Memory Fallback**: Automatic fallback when MongoDB unavailable
- **Dual Support**: All routes check `isMongoDBAvailable()` and handle both cases

### Authentication Architecture
```
Admin Login → ADMIN_JWT_SECRET → Admin Token → validateAdmin middleware
Client Widget → JWT_SECRET → Client Token → validateClient middleware
```

### API Routes Structure
- `/api/auth/*` - No middleware for login, validateAdmin for client management
- `/api/chat/*` - validateClient middleware, real OpenAI integration
- `/api/analytics/*` - validateClient middleware, usage data
- `/api/test/*` - No authentication, debugging endpoints
- `/widget.js` - Static file, embeddable chat interface

### MongoDB Models Relationships
```
Client (1) → (∞) Session → (∞) Message
   ↓
Stores: assistantId, widgetTitle, widgetGreeting, token
```

## Critical Implementation Details

### Widget Personalization Flow
1. Admin creates client with `widgetTitle` and `widgetGreeting`
2. Backend generates widget code with `data-title` and `data-greeting` attributes
3. Widget.js reads these attributes and displays personalized UI
4. Token includes these values for runtime access

### CORS Configuration
- Hardcoded origins in `src/index.js` include main domains
- `ALLOWED_ORIGINS` env var adds additional origins dynamically
- Widget uses `Access-Control-Allow-Origin: *` for broad compatibility

### Session Management
1. Widget calls `POST /api/chat/session` → creates OpenAI thread
2. Returns `sessionId` linked to `threadId`
3. Messages sent to `POST /api/chat/message` with `sessionId`
4. OpenAI maintains conversation context via threads

### Environment Variables
Required:
- `OPENAI_API_KEY` - Powers chat functionality
- `JWT_SECRET` - Signs client tokens
- `ADMIN_JWT_SECRET` - Signs admin tokens

Optional but recommended:
- `MONGODB_URI` - Enables persistence
- `ALLOWED_ORIGINS` - Additional CORS domains
- `WIDGET_URL` - Override default widget URL

## Common Issues & Solutions

### Route Naming Conflicts
Frontend expects singular routes (`/client`, `/session`, `/message`) while some MongoDB examples use plural. Always use singular to match frontend expectations.

### Token Regeneration
When `widgetTitle` or `widgetGreeting` changes, the token must be regenerated to include new values in the JWT payload.

### Widget Integration
Widget expects exact attribute names: `data-client-token`, `data-title`, `data-greeting`. The backend must generate these exactly.

## Version Control & Recovery

**Current Stable Version**: `v2.0-stable` - MongoDB + Full personalization

### Emergency Recovery
```bash
git checkout v2.0-stable
git push --force origin main
```

### Creating New Stable Version
```bash
git tag -a vX.X-stable -m "Description"
git push origin vX.X-stable
```

## Development Workflow

1. **Feature Development**: Work on `main` branch
2. **Testing**: Use local MongoDB or rely on in-memory fallback
3. **Deployment**: Push to GitHub → Auto-deploy to Vercel
4. **Rollback**: Use git tags to revert to stable versions

## Recent Architecture Decisions

### MongoDB Integration (Dec 2024)
- Added mongoose models while maintaining in-memory compatibility
- All routes support dual storage to ensure zero downtime during migration

### Widget Personalization (Dec 2024)
- Added `widgetTitle` and `widgetGreeting` to Client model
- Widget code generation includes these as data attributes
- Frontend can update these via PUT `/api/auth/client/:clientId`

### CORS Enhancement (Dec 2024)
- Added GitHub Pages support for testing
- Implemented environment variable for dynamic origins
- Maintained hardcoded list for critical domains

## Important Notes

- Always maintain backward compatibility with existing widgets
- Spanish error messages are intentional for target market
- Rate limiting is per-IP, not per-client
- OpenAI threads are not reused between sessions
- CLAUDE.md should always be in .gitignore