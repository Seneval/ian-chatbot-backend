# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Current Status

- **Production URL**: https://ian-chatbot-backend-h6zr.vercel.app
- **Admin Dashboard**: https://admin.inteligenciaartificialparanegocios.com
- **Sentry Project**: https://ian-hh.sentry.io (project: ian-chatbot-backend)
- **MongoDB**: Connected with Atlas cluster (IP whitelist required: 0.0.0.0/0 for Vercel)
- **Widget**: Serving from `/widget.js` with personalization support
- **Pricing Model**: Per-chatbot ($200 MXN/month per premium chatbot)

## Commands

### Development
- **Run development server**: `npm run dev` - Starts server with nodemon on port 3000 (auto-reloads on changes)
- **Start production server**: `npm start` - Runs server without auto-reload
- **Install dependencies**: `npm install` - Installs all packages including mongoose for MongoDB
- **Clean install**: `rm -rf node_modules package-lock.json && npm install` - Resolves dependency issues
- **Kill server**: `pkill -f "node.*ian-chatbot"` - Stops any running Node.js server

### Deployment
- **Deploy to Vercel**: `git push origin main` - Auto-deploys on push to main
- **Manual deploy**: `vercel` - Deploys to production manually
- **Preview deployment**: Push to any branch creates preview URL
- **Check deployment**: https://ian-chatbot-backend-h6zr.vercel.app/api/health

### Testing
- **Manual API testing**: Use `/api/test/*` endpoints (no auth required)
- **Test OpenAI assistant**: `GET /api/test/assistant/:assistantId`
- **Full chat flow test**: `POST /api/test/full-test`
- **Test Sentry integration**: 
  - Status: `GET /api/test-sentry/status`
  - Trigger error: `GET /api/test-sentry/error`
  - Custom error: `GET /api/test-sentry/custom-error`

## Multi-Agent Architecture

This backend works in conjunction with another Claude Code agent managing the frontend repository (`ian2` or `ianwebsite`). 

### Agent Responsibilities
- **This agent (Backend)**: 
  - API endpoints and business logic
  - Database models and migrations
  - Authentication and authorization
  - Widget serving (`/widget.js`)
  - OpenAI integration

- **Frontend agent (ian2/ianwebsite)**:
  - Admin dashboard UI
  - Client management interface
  - Analytics visualization
  - Makes API calls to this backend

### Cross-Repository Communication
When the frontend needs changes:
1. Frontend expects specific API endpoints (e.g., `/client` not `/clients`)
2. Frontend sends `x-client-token` header for client auth
3. Frontend sends `Authorization: Bearer` header for admin auth
4. Widget embeds are generated by backend, consumed by frontend

## Architecture Overview

### Core Flow
```
Frontend Dashboard → API Endpoints → MongoDB/In-Memory Storage
         ↓                  ↓
   Widget Embed ← Widget.js ← OpenAI Assistant
```

### Project Structure
```
/
├── api/
│   └── index.js          # Vercel serverless entry point
├── src/
│   ├── index.js          # Express app configuration
│   ├── instrument.js     # Sentry initialization
│   ├── api/              # Route handlers
│   ├── models/           # MongoDB/Mongoose models
│   ├── middleware/       # Auth middleware
│   ├── config/           # Database config
│   └── admin/            # Admin dashboard static files
├── public/
│   ├── homepage/         # Landing page
│   └── widget.js         # Embeddable chat widget
└── vercel.json           # Vercel configuration
```

### Database Strategy
- **MongoDB**: Primary storage when `MONGODB_URI` is set
- **In-Memory Fallback**: Automatic fallback when MongoDB unavailable
- **Dual Support**: All routes check `isMongoDBAvailable()` and handle both cases

### Authentication Architecture
```
Admin Login → ADMIN_JWT_SECRET → Admin Token → validateAdmin middleware
Client Widget → JWT_SECRET → Client Token → validateClient middleware
Tenant User → JWT_SECRET → Tenant Token → validateTenant middleware
```

### API Routes Structure
- `/api/auth/*` - No middleware for login, validateAdmin for client management
- `/api/chat/*` - validateClient middleware, real OpenAI integration
- `/api/analytics/*` - validateAdmin middleware, usage data
- `/api/test/*` - No authentication, debugging endpoints
- `/api/test-sentry/*` - Sentry error testing endpoints
- `/api/register/*` - Tenant registration (no auth required)
- `/api/tenant/*` - Multi-tenant authentication
- `/widget.js` - Static file, embeddable chat interface

### MongoDB Models Relationships
```
Tenant (1) → (∞) User
   ↓
   (1) → (∞) Client (Chatbot) → (∞) Session → (∞) Message
                ↓
         Stores: plan (free/paid), pricing info, usage limits
```

## Critical Implementation Details

### Per-Chatbot Pricing Model (Jan 2025)
- **Free Plan**: 10 calls/day per chatbot, unlimited chatbots
- **Premium Plan**: $200 MXN/month per chatbot, 1,000 calls/day
- Client model updated with pricing structure and usage tracking
- Middleware checks per-chatbot limits before processing messages
- Usage tracked at chatbot level, not tenant level

### Widget Personalization Flow
1. Admin creates client with `widgetTitle` and `widgetGreeting`
2. Backend generates widget code with `data-title` and `data-greeting` attributes
3. Widget.js reads these attributes and displays personalized UI
4. Token includes these values for runtime access

### CORS Configuration
- Hardcoded origins in `src/index.js` include main domains
- `ALLOWED_ORIGINS` env var adds additional origins dynamically
- Widget uses `Access-Control-Allow-Origin: *` for broad compatibility

### Session Management
1. Widget calls `POST /api/chat/session` → creates OpenAI thread
2. Returns `sessionId` linked to `threadId`
3. Messages sent to `POST /api/chat/message` with `sessionId`
4. OpenAI maintains conversation context via threads
5. Daily usage limits enforced per chatbot

### Environment Variables
Required:
- `OPENAI_API_KEY` - Powers chat functionality
- `JWT_SECRET` - Signs client tokens
- `ADMIN_JWT_SECRET` - Signs admin tokens

Optional but recommended:
- `MONGODB_URI` - Enables persistence (must include database name: `/ian-chatbot`)
- `ALLOWED_ORIGINS` - Additional CORS domains (comma-separated)
- `WIDGET_URL` - Override default widget URL
- `SENTRY_DSN` - Error tracking (get from https://ian-hh.sentry.io)

## Common Issues & Solutions

### Sentry Initialization Bug (Fixed Jan 2025)
**Problem**: Sentry wasn't initializing because `require('dotenv').config()` was called AFTER `require('./instrument')`.

**Solution**: In `src/index.js`, moved dotenv to the first line:
```javascript
// Load environment variables FIRST
require('dotenv').config();

// Initialize Sentry AFTER environment variables are loaded
require('./instrument');
```

**Key Learning**: Environment variables must be loaded before any module that depends on them.

### Route Naming Conflicts
Frontend expects singular routes (`/client`, `/session`, `/message`) while some MongoDB examples use plural. Always use singular to match frontend expectations.

### Token Regeneration
When `widgetTitle` or `widgetGreeting` changes, the token must be regenerated to include new values in the JWT payload.

### Widget Integration
Widget expects exact attribute names: `data-client-token`, `data-title`, `data-greeting`. The backend must generate these exactly.

### Dashboard Form Errors
The dashboard expects these exact field IDs: `businessName`, `contactEmail`, `plan`, `assistantId`. Removed `monthlyMessageLimit` field after switching to per-chatbot pricing.

### Vercel Deployment Issues
Common causes and solutions:
1. **Invalid package versions**: 
   - bcryptjs must be ^2.4.3 (not 3.0.0+)
   - Express must be v4 (not v5 beta)
2. **Runtime configuration**: 
   - Use `@vercel/node@2.0.0` in vercel.json
   - Node version: >=16.0.0
3. **Serverless setup**:
   - App is wrapped via `/api/index.js` entry point
   - Sentry initialized in `/src/instrument.js` before app loads
   - Server doesn't listen in production (check for VERCEL env)
4. **Missing files**: Ensure all static files are included in deployment

## Version Control & Recovery

**Current Stable Version**: `v5.0-stable` - Per-chatbot pricing model with Sentry fix

### Available Stable Versions
- `v5.0-stable` - Current: Per-chatbot pricing + Sentry fix
- `v4.1-stable` - Sentry + Admin subdomain + Analytics
- `v3.1-stable` - Admin subdomain + Analytics  
- `v2.0-stable` - MongoDB + Widget personalization
- `v1.0-stable` - Basic functionality

### Emergency Recovery
```bash
git checkout v5.0-stable
git push --force origin main
```

### Creating New Stable Version
```bash
git tag -a vX.X-stable -m "Description"
git push origin vX.X-stable
```

## Development Workflow

1. **Feature Development**: Work on `main` branch
2. **Testing**: Use local MongoDB or rely on in-memory fallback
3. **Deployment**: Push to GitHub → Auto-deploy to Vercel
4. **Rollback**: Use git tags to revert to stable versions

## Recent Architecture Decisions

### Per-Chatbot Pricing Model (Jan 2025)
- Switched from tenant-based to per-chatbot pricing
- Updated Client model with `plan` (free/paid) and `pricing` object
- Added daily/monthly usage tracking per chatbot
- Modified `checkUsageLimit` middleware to check chatbot limits
- Updated landing page and dashboard to reflect new pricing

### Sentry Integration (Jan 2025)
- Added `@sentry/node` for error tracking
- Separate `instrument.js` for early initialization in serverless
- Custom test endpoints in `/api/test-sentry/*`
- Captures console errors, unhandled rejections, and custom contexts
- **Critical**: Fixed initialization order bug by loading dotenv first

### Admin Subdomain (Jan 2025)
- Configured admin.inteligenciaartificialparanegocios.com
- Auto-redirect from subdomain root to /admin
- Added to CORS allowed origins
- DNS: CNAME to cname.vercel-dns.com

### Analytics Implementation (Dec 2024)
- Complete conversation log viewing system
- Modal-based UI for viewing session details
- Admin-only access via validateAdmin middleware

### MongoDB Integration (Dec 2024)
- Added mongoose models while maintaining in-memory compatibility
- All routes support dual storage to ensure zero downtime during migration
- Must whitelist IPs in MongoDB Atlas (0.0.0.0/0 for Vercel)

### Widget Personalization (Dec 2024)
- Added `widgetTitle` and `widgetGreeting` to Client model
- Widget code generation includes these as data attributes
- Frontend can update these via PUT `/api/auth/client/:clientId`

### CORS Enhancement (Dec 2024)
- Added GitHub Pages support for testing
- Implemented environment variable for dynamic origins
- Maintained hardcoded list for critical domains
- Fixed callback handling for proper CORS rejection

## Known Issues (from Sentry)

1. **Trust Proxy Warning** (IAN-CHATBOT-BACKEND-6):
   - Rate limiting bypass vulnerability due to `trust proxy: true`
   - Need to configure proper proxy trust settings for Vercel

2. **Missing demo.html** (IAN-CHATBOT-BACKEND-3):
   - Root route tries to serve non-existent demo.html
   - Need to add file or change default route

3. **Punycode Deprecation Warning**:
   - Node.js deprecation warning from dependencies
   - Harmless but shows in logs/Sentry
   - Will be fixed when packages update

## Important Notes

- Always maintain backward compatibility with existing widgets
- Spanish error messages are intentional for target market
- Rate limiting is per-IP, not per-client
- OpenAI threads are not reused between sessions
- CLAUDE.md should always be in .gitignore
- Never include Co-Authored-By Claude in git commits
- When creating chatbots locally, they won't work with production widget

## Multi-Tenant Architecture

### Models Added
- `Tenant` - Organization with subscription info
- `User` - Tenant users with roles (owner, admin, member)
- Added `tenantId` to Client, Session, Message models

### Middleware Added
- `validateTenant` - Validates tenant user tokens
- `validateTenantOwner` - Owner-only operations
- `validateSuperAdmin` - Platform administration

### Endpoints Added
- `POST /api/register/register` - Create tenant + owner user
- `POST /api/tenant/login` - Tenant user login
- `GET /api/tenant/me` - Current user info
- Tenant-scoped client management endpoints

### Current Tenant Plans (Not active - using per-chatbot pricing)
- **Trial**: 5 clients, 1 user, 1,000 messages/month
- **Starter**: 50 clients, 3 users, 100,000 messages/month
- **Pro**: 200 clients, 10 users, 500,000 messages/month
- **Enterprise**: 1,000 clients, 50 users, 2,000,000 messages/month